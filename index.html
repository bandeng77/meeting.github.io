<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalender & Booking Meeting</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-6xl mx-auto py-10 px-4">
    <h1 class="text-center text-3xl font-bold mb-6">Kalender & Booking Meeting</h1>
    <div id="calendar" class="bg-white rounded shadow p-4 mb-6"></div>
    <div id="schedule" class="bg-white rounded shadow p-4 hidden mb-6">
      <h2 id="scheduleTitle" class="text-xl font-semibold mb-3">Jadwal</h2>
      <ul id="scheduleList" class="space-y-2 text-gray-700"></ul>
    </div>
    <div class="bg-white rounded shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Form Booking Meeting</h2>
      <form id="bookingForm" class="space-y-4">
        <div><label>Ruang</label><input name="ruang" type="text" class="w-full border px-3 py-2" required></div>
        <div><label>Pengguna</label><input name="pengguna" type="text" class="w-full border px-3 py-2" required></div>
        <div><label>Tanggal</label><input name="tanggal" type="date" class="w-full border px-3 py-2" required></div>
        <div><label>Mulai</label><input name="mulai" type="time" class="w-full border px-3 py-2" required></div>
        <div><label>Selesai</label><input name="selesai" type="time" class="w-full border px-3 py-2" required></div>
        <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded">Booking Sekarang</button>
      </form>
      <p id="bookingFeedback" class="mt-4 text-sm"></p>
    </div>
    <p id="lastUpdate" class="text-center text-xs text-gray-500 mt-6"></p>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const sheetURL = `https://docs.google.com/spreadsheets/d/1YWa05qOIiiaefYJ0NScm7Vnnixl7IhDUfGqy6Nry-6c/gviz/tq?tqx=out:json`;
      let allEvents = [];

      function loadCalendar() {
        fetch(sheetURL).then(r => r.text()).then(d => {
          const json = JSON.parse(d.substr(47).slice(0, -2));
          const rows = json.table.rows; allEvents = [];
          rows.forEach(r => {
            const [ruang, status, pengguna, tanggal, mulai, selesai] = r.c.map(c => c?.v || "");
            if (tanggal && status.toLowerCase() !== "tersedia") {
              allEvents.push({ruang, pengguna, status, date: tanggal, mulai, selesai, title:`${ruang} - ${pengguna}`, start:`${tanggal}T${mulai}`, end:`${tanggal}T${selesai}`});
            }
          });

          const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
            initialView:"dayGridMonth", locale:"id", height:"auto",
            headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek"},
            events:allEvents.map(e => ({title:e.title, start:e.start, end:e.end, color:e.status.toLowerCase()==="digunakan"?"#f87171":"#facc15"})),
            dateClick: info => {
              const dateStr = info.dateStr;
              const items = allEvents.filter(e => e.date === dateStr);
              document.getElementById("scheduleTitle").innerText = `Jadwal untuk ${new Date(dateStr).toLocaleDateString("id-ID")}`;
              const list = items.length ? items.map(e => `<li class="border-l-4 pl-4 border-blue-500"><strong>${e.ruang}</strong> - ${e.pengguna} (${e.mulai}â€‘${e.selesai})</li>`).join("") : `<li class="text-gray-500">Semua ruang tersedia.</li>`;
              document.getElementById("scheduleList").innerHTML = list;
              document.getElementById("schedule").classList.remove("hidden");
            }
          });
          calendar.render();

          document.getElementById("lastUpdate").textContent = "Terakhir diperbarui: "+new Date().toLocaleString("id-ID");
        }).catch(err => {
          document.getElementById("calendar").innerHTML = "<p class='text-red-600'>Gagal memuat kalender.</p>";
          console.error(err);
        });
      }

      loadCalendar();

      document.getElementById("bookingForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const data = new URLSearchParams(new FormData(this));
        fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec", {
          method:"POST", body:data
        }).then(r=>r.json()).then(json=>{
          if(json.success) {
            bookingFeedback.textContent = "Booking berhasil! Kalender akan diperbarui dalam beberapa detik.";
            bookingFeedback.className="text-green-600";
            setTimeout(loadCalendar,2000);
          } else {
            bookingFeedback.textContent = "Gagal booking: "+json.error;
            bookingFeedback.className="text-red-600";
          }
        }).catch(err=>{
          bookingFeedback.textContent = "Error koneksi.";
          bookingFeedback.className="text-red-600";
          console.error(err);
        });
      });
    });
  </script>
</body>
</html>
