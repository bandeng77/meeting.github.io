// FINAL VERSION - Integrated with Google Sheets backend
// Replace <script> section only

const backendURL = 'https://script.google.com/macros/s/AKfycbwx5tZhvVJ5YRXfg8StEkkXDjmhVs1jNduIl2AkTJvctLmtv_I-sdcDyRWB6qw2yMzL/exec';

let meetingsData = {};
const availableTimes = ['09:00', '10:00', '11:00', '13:00', '14:00', '15:00', '16:00'];
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let selectedDate = null;
let selectedTime = null;

const calendarGrid = document.getElementById('calendar-grid');
const selectedDateDisplay = document.getElementById('selected-date');
const meetingsDateDisplay = document.getElementById('meetings-date');
const meetingsList = document.getElementById('meetings-list');
const bookingForm = document.getElementById('booking-form');
const bookingDateInput = document.getElementById('date');
const bookingTimeInput = document.getElementById('time');
const prevMonthBtn = document.getElementById('prev-month');
const nextMonthBtn = document.getElementById('next-month');

function showLoading(show) {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) overlay.classList.toggle('hidden', !show);
}

async function loadMeetings() {
  try {
    showLoading(true);
    const res = await axios.get(backendURL);
    meetingsData = res.data || {};
    if (selectedDate) {
      const dateString = formatDate(selectedDate);
      updateMeetingsList(dateString);
      updateTimeSlots();
    }
  } catch (error) {
    console.error('Failed to load meetings:', error);
    alert('Gagal mengambil data meeting dari Google Sheets');
  } finally {
    showLoading(false);
  }
}

function initCalendar() {
  renderCalendar(currentMonth, currentYear);
  updateTimeSlots();
  const today = new Date();
  const dateString = formatDate(today);
  selectDate(today, dateString);
  loadMeetings();
}

function renderCalendar(month, year) {
  calendarGrid.innerHTML = '';
  const firstDay = new Date(year, month, 1);
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const startingDay = firstDay.getDay();
  const prevMonthDays = new Date(year, month, 0).getDate();

  for (let i = 0; i < startingDay; i++) {
    const dayElement = createDayElement(prevMonthDays - startingDay + i + 1, true);
    calendarGrid.appendChild(dayElement);
  }

  for (let i = 1; i <= daysInMonth; i++) {
    const date = new Date(year, month, i);
    const dateString = formatDate(date);
    const hasMeetings = meetingsData[dateString] && meetingsData[dateString].length > 0;
    const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();
    const isToday = date.toDateString() === new Date().toDateString();

    const dayElement = createDayElement(i, false, hasMeetings, isSelected, isToday);
    dayElement.addEventListener('click', () => selectDate(date, dateString));
    calendarGrid.appendChild(dayElement);
  }

  const totalCells = startingDay + daysInMonth;
  const remainingCells = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
  for (let i = 1; i <= remainingCells; i++) {
    const dayElement = createDayElement(i, true);
    calendarGrid.appendChild(dayElement);
  }

  document.getElementById('calendar-header').previousElementSibling.textContent =
    `${new Date(year, month).toLocaleDateString('default', { month: 'long' })} ${year}`;
}

function createDayElement(day, isDisabled, hasMeetings = false, isSelected = false, isToday = false) {
  const dayElement = document.createElement('div');
  dayElement.className = 'calendar-day py-2 text-center rounded-md';

  if (isDisabled) {
    dayElement.classList.add('text-gray-300', 'disabled');
  } else {
    dayElement.classList.add('text-gray-800');
    if (isToday) dayElement.classList.add('font-bold', 'border', 'border-blue-500');
    if (hasMeetings) dayElement.classList.add('has-meetings');
    if (isSelected) dayElement.classList.add('selected', 'text-white');
  }

  dayElement.textContent = day;
  return dayElement;
}

function selectDate(date, dateString) {
  selectedDate = date;
  selectedTime = null;

  selectedDateDisplay.textContent = date.toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });
  meetingsDateDisplay.textContent = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
  bookingDateInput.value = dateString;
  bookingTimeInput.value = '';

  renderCalendar(currentMonth, currentYear);
  updateMeetingsList(dateString);
  updateTimeSlots();
  loadMeetings();
}

function updateMeetingsList(dateString) {
  meetingsList.innerHTML = '';
  if (!meetingsData[dateString] || meetingsData[dateString].length === 0) {
    meetingsList.innerHTML = `<div class="text-center py-8 text-gray-500">
      <p>No meetings scheduled for this date</p><p class="text-sm mt-2">Select a time slot below to schedule a meeting</p></div>`;
    return;
  }

  meetingsData[dateString].forEach(meeting => {
    const meetingElement = document.createElement('div');
    meetingElement.className = 'meeting-card p-4 border border-gray-200 rounded-lg';
    meetingElement.innerHTML = `<div class="flex justify-between items-start">
      <div><h3 class="font-semibold text-gray-800">${meeting.title}</h3>
      <p class="text-sm text-gray-500 mt-1">${meeting.time}</p></div>
      <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Scheduled</span>
    </div>
    <p class="text-sm text-gray-600 mt-2">${meeting.description}</p>
    <div class="mt-3">
      <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Participants</h4>
      <p class="text-xs mt-1">${meeting.participants.join(', ')}</p>
    </div>`;
    meetingsList.appendChild(meetingElement);
  });
}

function updateTimeSlots() {
  const timeSlotsContainer = document.querySelector('#time-slots .grid');
  timeSlotsContainer.innerHTML = '';

  if (!selectedDate) return;

  const dateString = formatDate(selectedDate);
  const bookedTimes = meetingsData[dateString]?.map(m => m.time) || [];

  availableTimes.forEach(time => {
    const isBooked = bookedTimes.includes(time);
    const timeSlot = document.createElement('div');
    timeSlot.className = `time-slot py-2 px-3 text-center rounded-md border ${isBooked ? 'bg-gray-100 text-gray-400 border-gray-200 booked' : 'border-gray-200'}`;
    timeSlot.textContent = time;

    if (!isBooked) {
      const isSelected = selectedTime === time;
      if (isSelected) timeSlot.classList.add('selected', 'text-white', 'border-blue-500');

      timeSlot.addEventListener('click', () => {
        document.querySelectorAll('.time-slot').forEach(slot => {
          slot.classList.remove('selected', 'text-white', 'border-blue-500');
        });
        timeSlot.classList.add('selected', 'text-white', 'border-blue-500');
        selectedTime = time;
        bookingTimeInput.value = time;
      });
    }

    timeSlotsContainer.appendChild(timeSlot);
  });
}

function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

prevMonthBtn.addEventListener('click', () => {
  currentMonth--;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  renderCalendar(currentMonth, currentYear);
});

nextMonthBtn.addEventListener('click', () => {
  currentMonth++;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  renderCalendar(currentMonth, currentYear);
});

bookingForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  if (!selectedDate || !selectedTime) {
    alert('Please select a date and time');
    return;
  }

  const title = document.getElementById('title').value;
  const participants = document.getElementById('participants').value
    .split(',').map(p => p.trim()).filter(p => p);
  const description = document.getElementById('description').value;
  const dateString = formatDate(selectedDate);

  try {
    await axios.post(backendURL, {
      date: dateString,
      time: selectedTime,
      title,
      participants,
      description
    });

    alert('Meeting scheduled!');
    bookingForm.reset();
    selectedTime = null;
    bookingTimeInput.value = '';

    await loadMeetings();
  } catch (error) {
    alert('Failed to schedule meeting');
    console.error(error);
  }
});

initCalendar();
